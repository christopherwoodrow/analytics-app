<html><head><link rel="stylesheet" href="../font-awesome/css/font-awesome.min.css">

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-localstorage/iron-localstorage.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">

<link rel="import" href="vaadin-license-box.html">
<link rel="import" href="vaadin-license-dialog.html">
<link rel="import" href="vaadin-license-notification.html">
<link rel="import" href="vaadin-framework-identifier.html">

</head><body><dom-module id="vaadin-license-checker">

    <template>
        <iron-localstorage id="storageLicense" name="[[storageKey]]" value="{{licenseKey}}" use-raw="true">

        </iron-localstorage>

        <iron-localstorage id="storageLicenseCheckTime" name="[[storageKeyCheckTime]]" value="{{licenseCheckTime}}" use-raw="true">

        </iron-localstorage>

        <iron-localstorage id="storageLicenseType" name="[[storageKeyType]]" value="{{licenseKeyType}}" use-raw="true">

        </iron-localstorage>

        <iron-ajax id="licenseRequest" url="[[licenseUrl]]" headers="[[licenseRequestHeaders]]" handle-as="json" on-response="_handleResultFromServer" on-error="_handleErrorFromServer" debounce-duration="300">
        </iron-ajax>
    </template>

    <script>LicenseChecker=Polymer({is:"vaadin-license-checker",instances:{},licenseDialog:void 0,licenseBox:void 0,notification:void 0,frameworkIdentifier:void 0,licenseTypes:{VALID:"valid",UNLICENSED:"unlicensed",TRIAL:"trial",EXPIRED:"expired"},properties:{licenseKey:{type:String,notify:!0},licenseCheckTime:{type:Number},licenseKeyType:{type:String},licenseUrlBase:{type:String,value:"https://tools.vaadin.com/vaadin-license-server/licenses/"},licenseUrl:{type:String,computed:"_computeUrl(licenseUrlBase, licenseKey)"},productName:String,productVersion:Number,productCaption:String,storageKey:{type:String,computed:"_computeStorageKey(productName)"},storageKeyCheckTime:{type:String,computed:"_computeStorageKeyCheckTime(productName)"},storageKeyType:{type:String,computed:"_computeStorageKeyType(productName)"},_yesterday:{type:Number,value:function(){var e=new Date;return e.setDate(e.getDate()-1),e.getTime()},readOnly:!0},_manualSubmit:{type:Boolean,value:!1},licenseRequestHeaders:String},attached:function(){this._exists(this.instances[this.storageKey])||(this.instances[this.storageKey]=this,this._isLocalhost()&&(this.$.storageLicense.reload(),this._exists(this.licenseKey)?this._checkLicenseKey():(void 0===this.licenseCheckTime&&(this.licenseCheckTime=window.localStorage.getItem(this._computeStorageKeyCheckTime(this.productName))),null===this.licenseCheckTime||this.licenseCheckTime<=this._yesterday?this._showLicenseDialog(this.licenseTypes.UNLICENSED):this._showLicenseBox(this.licenseTypes.UNLICENSED))))},detached:function(){this._existsAndAttached(this.licenseBox)&&(this._removeFromParent(this.licenseBox),this.licenseBox=void 0),this._existsAndAttached(this.licenseDialog)&&(this._removeFromParent(this.licenseDialog),this.licenseDialog=void 0),this._existsAndAttached(this.notification)&&(this._removeFromParent(this.notification),this.notification=void 0),this._existsAndAttached(this.frameworkIdentifier)&&(this._removeFromParent(this.frameworkIdentifier),this.frameworkIdentifier=void 0),this.instances[this.storageKey]===this&&(this.instances[this.storageKey]=void 0)},_removeFromParent:function(e){e.parentNode.removeChild(e)},_existsAndAttached:function(e){return e&&void 0!=e.parentNode},_checkLicenseKey:function(e,i){0===arguments.length&&(e=this.licenseKey);var t=this._computeUrl(this.licenseUrlBase,e);this._identifyFramework(),this._setLicenseRequestHeaders(),this.$.licenseRequest.url=t,this._manualSubmit=!!i,this.$.licenseRequest.generateRequest()},_computeUrl:function(e,i){return e+i},_handleErrorFromServer:function(e){this._manualSubmit||null==this.licenseCheckTime||this.licenseCheckTime<=this._yesterday?(this._showLicenseDialog(this.licenseTypes.UNLICENSED),this.licenseKeyType=this.licenseTypes.UNLICENSED,this.licenseCheckTime=(new Date).getTime()):this.licenseKeyType!==this.licenseTypes.VALID&&this._showLicenseBox(this.licenseKeyType||this.licenseTypes.UNLICENSED),this._fireLoadReadyEvent()},_handleResultFromServer:function(e){var i=e.detail,t=i.response;200==i.status&&this._isValidLicense(t.product.name,t.product.version)?!0===t.expired?(this.licenseKey=t.licenseKey,this._showLicenseBox(this.licenseTypes.EXPIRED),this.licenseKeyType=this.licenseTypes.EXPIRED):"evaluation"===t.type?(this.licenseKey=t.licenseKey,this._showLicenseBox(this.licenseTypes.TRIAL,t.expiredEpoch),this.licenseKeyType=this.licenseTypes.TRIAL):(this.licenseKey!==t.licenseKey&&(this._showSuccessNotification(),this.licenseKey=t.licenseKey),this.licenseKeyType=this.licenseTypes.VALID):(this._showLicenseDialog(this.licenseTypes.UNLICENSED),this.licenseKeyType=this.licenseTypes.UNLICENSED),this.licenseCheckTime=(new Date).getTime(),this._fireLoadReadyEvent()},_isLocalhost:function(){var e=window.location.hostname;return"localhost"===e||"127.0.0.1"===e},_isValidLicense:function(e,i){return e===this.productName&&(i==this.productVersion||!this._exists(i))},_fireLoadReadyEvent:function(){this.fire("license-check-done")},_exists:function(e){return null!==e&&void 0!==e&&""!==e},_computeStorageKey:function(e){return"vaadin."+e+".developer.license.key"},_computeStorageKeyCheckTime:function(e){return"vaadin."+e+".license.check.time"},_computeStorageKeyType:function(e){return"vaadin."+e+".license.key.type"},_licenseDialogClosed:function(e){this._showLicenseBox(e.detail.type,e.detail.expiryEpoch),this.licenseCheckTime=(new Date).getTime()},_licenseBoxClosed:function(e){this._showLicenseDialog(e.detail.type,e.detail.expiryEpoch)},_licenseBoxSubmit:function(e){this._checkLicenseKey(e.detail.licenseKey,!0),this.licenseCheckTime=(new Date).getTime()},_showLicenseDialog:function(e,i){this.licenseDialog||(this.licenseDialog=new LicenseDialog,Polymer.dom(document.body).appendChild(this.licenseDialog),this.licenseDialog.addEventListener("vaadin-license-dialog-close",this._licenseDialogClosed.bind(this)),this.licenseDialog.addEventListener("vaadin-license-dialog-submit",this._licenseBoxSubmit.bind(this))),this.licenseDialog.type=e,this.licenseDialog.productCaption=this.productCaption,e===this.licenseTypes.TRIAL&&(this.licenseDialog.expiryEpoch=i),this.licenseDialog.open()},_showLicenseBox:function(e,i){this.licenseBox||(this.licenseBox=new LicenseBox,Polymer.dom(document.body).appendChild(this.licenseBox),this.licenseBox.addEventListener("vaadin-license-box-close",this._licenseBoxClosed.bind(this))),this.licenseBox.type=e,this.licenseBox.productCaption=this.productCaption,e===this.licenseTypes.TRIAL&&(this.licenseBox.expiryEpoch=i),this.licenseBox.open()},_showSuccessNotification:function(){this.notification||(this.notification=new LicenseNotification,Polymer.dom(this.root).appendChild(this.notification),this.notification.addEventListener("click",this.notification.close)),this.notification.open()},_identifyFramework:function(){this.frameworkIdentifier||(this.frameworkIdentifier=new FrameworkIdentifier,Polymer.dom(this).appendChild(this.frameworkIdentifier)),this.frameworkIdentifier.setFrameWorkAndVersion()},_setLicenseRequestHeaders:function(){this.licenseRequestHeaders={"check-source":"webcomponent",framework:this.frameworkIdentifier.framework,version:this.frameworkIdentifier.version}}});</script>
</dom-module>
</body></html>